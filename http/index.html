<!DOCTYPE html>
<html>

<head>
    <script>
        class AudioPlayer {
            constructor() {
                let AudioContext = window.AudioContext || window.webkitAudioContext;
                this.audio_ctx = new AudioContext();

                this.null_audio = this.audio_ctx.createBuffer(1, 1000, this.audio_ctx.sampleRate);
                this.audio_buffers = [];

                this.buf_source = undefined;
            }

            #getNewBuffer() {
                if (this.audio_buffers.length == 0) {
                    console.log("no audio data :(");
                    this.buf_source = this.audio_ctx.createBufferSource();
                    this.buf_source.buffer = this.null_audio;
                } else {
                    this.buf_source = this.audio_buffers.shift();
                }
                this.buf_source.connect(this.audio_ctx.destination);
            }

            #playNextBuffer() {
                if (this.buf_source === undefined) {
                    // initialization
                    this.#getNewBuffer();
                    this.buf_source.start();
                    this.current_end_time = this.audio_ctx.currentTime + this.buf_source.buffer.duration;
                }
                this.buf_source.onended = (ev) => {
                    ev.target.disconnect(this.audio_ctx.destination);
                    this.#playNextBuffer();
                }
                this.#getNewBuffer();
                this.buf_source.start(this.current_end_time);
                this.current_end_time = this.current_end_time + this.buf_source.buffer.duration;
            }

            play() {
                this.#playNextBuffer();
            }

            getBufSize() {
                return this.audio_buffers.length;
            }

            addBuffer(data, sr) {
                if (!(data instanceof Float32Array)) {
                    throw new Error("Invalid audio type");
                }
                let buffer = this.audio_ctx.createBuffer(1, data.length, sr);
                buffer.copyToChannel(data, 0);
                let bufsrc = this.audio_ctx.createBufferSource();
                bufsrc.buffer = buffer;
                this.audio_buffers.push(bufsrc);
            }
        }

        class Waterfall {
            constructor(width, height) {
                this.width = width;
                this.height = height;

                this.low = 0;
                this.high = 0.001;

                this.canvas = document.getElementById("waterfall_canvas");
                this.ctx = this.canvas.getContext("2d");
                this.buffer = this.ctx.createImageData(this.width, this.height);
            }

            addLine(data) {
                if (!(data instanceof Float32Array)) {
                    throw new Error("Invalid type");
                }

                const newLine = new Uint8ClampedArray(this.width * 4);
                for (let x = 0; x < this.width; x++) {
                    const vs = (data[x] - this.low) / (this.high - this.low);
                    const vp = Math.min(255, Math.max(0, Math.floor(vs * 255)));
                    const i = x * 4;
                    newLine[i] = vp;
                    newLine[i + 1] = vp;
                    newLine[i + 2] = vp;
                    newLine[i + 3] = 255;
                }

                this.buffer.data.copyWithin(this.width * 4, 0, (this.height - 1) * this.width * 4);
                this.buffer.data.set(newLine, 0);
                this.ctx.putImageData(this.buffer, 0, 0);
            }

            addData(data) {
                if (!(data instanceof Float32Array)) {
                    throw new Error("Invalid type");
                }

                for (let offset = 0; offset < data.length; offset += this.width) {
                    const slice = data.subarray(offset, offset + this.width);
                    if (slice.length === this.width) {
                        this.addLine(slice);
                    }
                }
            }
        }
    </script>
    <script>
        function onLoad() {
            const audio_player = new AudioPlayer();
            const waterfall = new Waterfall(4800, 500);
            const ws = new WebSocket(`ws://${window.location.host}`);
            ws.onopen = function () {
                ws.send("Hii :3,,,");
                document.addEventListener('click', function (event) {
                    if (!event.target.matches("#audio_start_btn")) {
                        return;
                    }
                    event.preventDefault();
                    console.log("resuming audio");
                    audio_player.play();
                }, false);
                setInterval(function () {
                    if (audio_player.getBufSize() < 3) {
                        ws.send("grrf GIMME DATA");
                    }
                }, 0.1);
            }
            ws.onerror = function (error) {
                console.log(error);
            }
            ws.onmessage = function (msg) {
                console.log("received data");
                if (typeof (msg.data) === "string") {
                    return;
                }
                msg.data.arrayBuffer().then((data) => {
                    const bytes = new Uint8Array(data);
                    // new ArrayBuffer to ensure alignment
                    const dataBytes = new Uint8Array(new ArrayBuffer(bytes.length - 1));
                    dataBytes.set(bytes.subarray(1));
                    if (bytes[0] == 0x1) {
                        // TODO: endianness!!
                        audio_player.addBuffer(new Float32Array(dataBytes.buffer), 48000);
                        waterfall.addData(new Float32Array(dataBytes.buffer));
                    }
                    if (bytes[0] == 0x2) {
                        // TODO: endianness!!
                        waterfall.addData(new Float32Array(dataBytes));
                    }
                }).catch((error) => {
                    console.log("Error!", error);
                });
                //console.log(msg.data);
            };
        }
        document.addEventListener("DOMContentLoaded", onLoad, false);
    </script>
</head>

<body>
    <button id="audio_start_btn">Start Audio</button>
    <br>
    <canvas id="waterfall_canvas" style="width: 100%; height: 100%;"></canvas>
</body>

</html>
